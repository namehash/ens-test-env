services:
  devnet:
    image: ghcr.io/ensdomains/namechain:main-f037aec
    command: ./script/runDevnet.ts --testNames
    pull_policy: always
    ports:
      - "8545:8545" # L1 chain
      - "8546:8546" # L2 chain
      - "8547:8547" # Urg
    environment:
      ANVIL_IP_ADDR: "0.0.0.0"
    healthcheck:
      test: ["CMD", "curl", "--fail", "-s", "http://localhost:8000/health"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s
      start_interval: 1s

  ensindexer:
    image: ghcr.io/namehash/ensnode/ensindexer:1.3.1-ensv2.1
    pull_policy: always
    depends_on:
      postgres:
        condition: service_started
      ensrainbow:
        condition: service_healthy
      devnet:
        condition: service_started
    environment:
      ENSINDEXER_URL: http://ensindexer:42069
      ENSRAINBOW_URL: http://ensrainbow:3223
      DATABASE_URL: postgresql://postgres:password@postgres:5432/postgres
      DATABASE_SCHEMA: ens-test-env
      NAMESPACE: ens-test-env
      PLUGINS: ensv2,protocol-acceleration
      LABEL_SET_ID: ens-test-env
      LABEL_SET_VERSION: 0
      RPC_URL_15658733: http://devnet:8545
      RPC_URL_15658734: http://devnet:8546
    healthcheck:
      test: ["CMD", "curl", "--fail", "-s", "http://localhost:42069/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 5m
      start_interval: 1s

  ensrainbow:
    image: ghcr.io/namehash/ensnode/ensrainbow:1.3.1-ensv2.1
    pull_policy: always
    environment:
      DB_SCHEMA_VERSION: 3
      LABEL_SET_ID: ens-test-env
      LABEL_SET_VERSION: 0
      LOG_LEVEL: error
    volumes:
      - ensrainbow_data:/app/apps/ensrainbow/data
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost:3223/health"]
      interval: 30s
      timeout: 5s
      retries: 2
      start_period: 2m
      start_interval: 1s

  ensapi:
    image: ghcr.io/namehash/ensnode/ensapi:1.3.1-ensv2.1
    pull_policy: always
    ports:
      - "4334:4334"
    depends_on:
      postgres:
        condition: service_started
      ensindexer:
        condition: service_healthy
    environment:
      ENSINDEXER_URL: http://ensindexer:42069
      DATABASE_URL: postgresql://postgres:password@postgres:5432/postgres

  ensadmin:
    image: ghcr.io/namehash/ensnode/ensadmin:1.3.1-ensv2.1
    pull_policy: always
    ports:
      - "4173:4173"
    environment:
      ENSADMIN_PUBLIC_URL: http://localhost:4173
      NEXT_PUBLIC_DEFAULT_ENSNODE_URLS: http://localhost:4334
    depends_on:
      - ensapi

  postgres:
    restart: always
    image: postgres:17
    environment:
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: password
    tmpfs:
      - /var/lib/postgresql/data

  metadata:
    image: ghcr.io/ensdomains/ens-metadata-service:latest
    depends_on:
      - devnet
      - ensindexer
    ports:
      - "8080:8080"
    environment:
      - ADDRESS_ETH_REGISTRAR=0xb7278a61aa25c888815afc32ad3cc52ff24fe575
      - ADDRESS_NAME_WRAPPER=0xfd471836031dc5108809d173a067e8486b9047a3
      - RPC_PROVIDER=http://devnet:8545
      - SUBGRAPH_URL=http://ensindexer:42069/subgraph

volumes:
  ensrainbow_data:
    driver: local
